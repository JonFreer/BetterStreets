<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    #mask_canvas {
        position: absolute;
        left: 0px;
        top: 0px;
        opacity: 0;
        /* visibility: hidden; */
    }

    #canvas {
        position: absolute;
        left: 0px;
        top: 0px;
    }
</style>

<body>
    <canvas height="800" width="800" id="canvas"></canvas>
    <canvas height="800" width="800" id="mask_canvas"></canvas>
    <script>
        var canvas = document.getElementById('canvas');
        var maskCanvas = document.getElementById('mask_canvas');
        ctx = canvas.getContext('2d');
        var img1 = new Image();
        var points = []
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(maskCanvas, 0, 0);
            ctx.globalCompositeOperation = 'source-in';

           

            ctx.filter = 'blur(40px)';
            ctx.drawImage(img1, 0, 0);
            // ctx.beginPath();
            // ctx.rect(0, 0, 1500,1500);
            // ctx.fill();
            ctx.filter = 'blur(0px)';
            ctx.globalCompositeOperation = 'destination-over';
            ctx.filter = 'blur(0px)';
            // ctx.drawImage(maskCanvas, 0, 0);
            ctx.drawImage(img1, 0, 0);
            ctx.globalCompositeOperation = 'source-over';
        }

        img1.onload = function () {

           
            ctx.globalCompositeOperation = 'source-in';
            //draw background image
           
            
            ctx.filter = 'blur(8px)';
            
            ctx.drawImage(img1, 0, 0);

            ctx.globalCompositeOperation = 'destination-over';
            ctx.filter = 'blur(0px)';


            // ctx.beginPath();
            // ctx.rect(20, 20, 150, 100);
            // ctx.fill(); //redraw mask to deal with transparency


            ctx.drawImage(img1, 0, 0);
            // ctx.drawImage(img1, 0, 0, 200, 200, 0, 0, 800, 800);
            ctx.globalCompositeOperation = 'source-over';

            //draw a box over the top
            // ctx.fillStyle = "rgba(200, 0, 0, 0.5)";
            // ctx.fillRect(0, 0, 500, 500);

        };

        function redrawMask() {
            mask_ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < points.length; i++) {
                if (points[i].mode == "draw") {
                    mask_ctx.beginPath();
                    mask_ctx.moveTo(points[i].x, points[i].y);
                    mask_ctx.lineTo(points[i].newX, points[i].newY);
                    mask_ctx.stroke();
                }

            }
            draw()
        }

        function undo(){
            if(points.length==0){
                return
            }
            last = points.pop()
            if(last.mode!="begin"){
                undo()
            }

        }

        img1.src = '/Users/jonfreer/Documents/BadlyParked/badlyparked/api/data/full/0f3624f9-a5aa-4b02-a6e6-b5753fde1988.WebP';

        let x = 0, y = 0;
        let isMouseDown = false;

        const stopDrawing = () => {
            isMouseDown = false;
            points.push({ x: x, y: y, mode: "end" });
        }

        const startDrawing = event => {
            isMouseDown = true;
            [x, y] = [event.offsetX, event.offsetY];
            points.push({ x: x, y: y, mode: "begin" });
        }

        mask_ctx = maskCanvas.getContext('2d');
        mask_ctx.lineWidth = 20;
        mask_ctx.lineCap = 'round';
        const drawLine = event => {
            if (isMouseDown) {
                console.log("move")


                const newX = event.offsetX;
                const newY = event.offsetY;
                mask_ctx.beginPath();
                mask_ctx.moveTo(x, y);
                mask_ctx.lineTo(newX, newY);
                mask_ctx.stroke();

                points.push({
                    newX: newX,
                    newY: newY,
                    x: x,
                    y: y,
                    // size: brushSize,
                    // color: brushColor,
                    mode: "draw"
                });

                //[x, y] = [newX, newY];
                x = newX;
                y = newY;
                draw();


            }
        }


        maskCanvas.addEventListener('mousedown', startDrawing);
        maskCanvas.addEventListener('mousemove', drawLine);
        maskCanvas.addEventListener('mouseup', stopDrawing);
        maskCanvas.addEventListener('mouseout', stopDrawing);
    </script>
</body>

</html>